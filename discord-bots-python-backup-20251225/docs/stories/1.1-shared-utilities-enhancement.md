# Story 1.1: Shared Utilities Enhancement

**Phase:** 1 - Foundation  
**Priority:** Critical  
**Effort:** Medium  
**Status:** Ready

---

## Story

As a bot developer, I want enhanced shared utilities with database abstraction, unified error handling, and common templates so that I can build new bots faster and maintain consistency across the ecosystem.

---

## Context

Currently, each bot has its own database access patterns, error handling, and embed creation. This leads to code duplication and inconsistencies. We need a robust shared utilities layer that all bots can rely on.

---

## Acceptance Criteria

### Database Abstraction Layer

- [ ] Create `database/` module with SQLAlchemy ORM
- [ ] Implement async session management with connection pooling
- [ ] Create base models: User, Guild, UserBotStats
- [ ] Add migration support with Alembic
- [ ] Support both SQLite (dev) and PostgreSQL (prod)
- [ ] All database queries use the abstraction layer
- [ ] Connection pooling configured (min=5, max=20)

### Unified Error Handling

- [ ] Create `utils/errors.py` with custom exception classes
- [ ] Implement error handler decorator for commands
- [ ] Log all errors to file and Sentry (if configured)
- [ ] User-friendly error messages in embeds
- [ ] Error responses follow consistent format
- [ ] Rate limit errors handled gracefully

### Common Embed Templates

- [ ] Create `utils/embeds.py` with embed templates
- [ ] Templates: success, error, warning, info, help
- [ ] Consistent color scheme across all bots
- [ ] Support for fields, footers, thumbnails
- [ ] Automatic timestamp inclusion option
- [ ] Character limit handling (truncate with ellipsis)

### Rate Limiting Utilities

- [ ] Create `utils/rate_limit.py` decorator
- [ ] Per-user rate limiting
- [ ] Per-command cooldowns
- [ ] Guild-wide rate limits
- [ ] Bypass for admins/moderators
- [ ] Clear error messages when rate limited

### Permission Checking Framework

- [ ] Create `utils/permissions.py` module
- [ ] Decorators: `@requires_admin`, `@requires_moderator`
- [ ] Role-based permission checking
- [ ] Guild owner bypass
- [ ] Bot owner bypass for all checks
- [ ] Clear permission denied messages

---

## Technical Notes

### Database Models

```python
# database/models/user.py
from sqlalchemy import Column, BigInteger, Integer, Text, Boolean, TIMESTAMP
from database.base import Base

class User(Base):
    __tablename__ = "users"

    id = Column(BigInteger, primary_key=True)  # Discord ID
    username = Column(Text, nullable=False)
    discriminator = Column(Text)
    total_xp = Column(Integer, default=0)
    level = Column(Integer, default=1)
    is_premium = Column(Boolean, default=False)
    created_at = Column(TIMESTAMP, server_default="CURRENT_TIMESTAMP")
```

### Error Handler Pattern

```python
# utils/errors.py
from discord.ext import commands

class BotError(commands.CommandError):
    """Base error for bot errors"""
    pass

class RateLimitError(BotError):
    """Rate limit exceeded"""
    pass

class PermissionError(BotError):
    """Insufficient permissions"""
    pass

# Usage
@bot.tree.error
async def on_error(interaction, error):
    if isinstance(error, RateLimitError):
        await interaction.response.send_message(
            embed=create_error_embed(str(error)),
            ephemeral=True
        )
```

### Rate Limiting Pattern

```python
# utils/rate_limit.py
from functools import wraps
from collections import defaultdict
import time

rate_limits = defaultdict(list)

def rate_limit(max_calls: int, time_window: int):
    def decorator(func):
        @wraps(func)
        async def wrapper(interaction, *args, **kwargs):
            user_id = interaction.user.id
            now = time.time()

            # Clean old entries
            rate_limits[user_id] = [
                t for t in rate_limits[user_id]
                if now - t < time_window
            ]

            if len(rate_limits[user_id]) >= max_calls:
                raise RateLimitError(
                    f"Please wait {time_window}s between commands"
                )

            rate_limits[user_id].append(now)
            return await func(interaction, *args, **kwargs)
        return wrapper
    return decorator
```

---

## Dependencies

- SQLAlchemy 2.0+ (async support)
- Alembic (migrations)
- aiosqlite (SQLite async)
- asyncpg (PostgreSQL async)

---

## Testing Requirements

- [ ] Unit tests for database models
- [ ] Integration tests for database operations
- [ ] Unit tests for error handlers
- [ ] Unit tests for rate limiting
- [ ] Unit tests for permission checking
- [ ] Mock Discord objects for testing

---

## Migration Path

1. Create new `database/` and enhanced `utils/` modules
2. Update existing bots one at a time to use new utilities
3. Migrate bot-specific databases to shared schema
4. Remove old utility code from bots
5. Update documentation

---

## Success Metrics

- All 3 existing bots use shared database layer
- Error handling is consistent across all bots
- No code duplication in embed creation
- Rate limiting prevents abuse (< 1% violations)
- Permission checks work correctly (0 bypasses)

---

## Related Stories

- Story 1.2: Configuration System
- Story 1.3: Testing Framework
- Story 2.1: Universal Leveling System

---

**Created:** 2025-12-21  
**Estimated Completion:** 2 weeks
