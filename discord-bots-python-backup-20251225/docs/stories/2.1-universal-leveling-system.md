# Story 2.1: Universal Leveling System

**Phase:** 2 - Gamification  
**Priority:** High  
**Effort:** Large  
**Status:** Blocked (requires Story 1.1)

---

## Story

As a Discord server member, I want to earn XP and level up across all bots in the ecosystem so that I feel rewarded for my engagement and can track my progress.

---

## Context

Gamification increases user engagement and retention. A universal leveling system that works across all bots provides a unified progression experience. Users should gain XP from any bot interaction and see their level consistently displayed.

---

## Acceptance Criteria

### XP Gain System

- [ ] XP awarded for command executions
- [ ] XP amounts configurable per bot
- [ ] Base XP per command: 5 XP
- [ ] Bonus XP for streaks (daily usage)
- [ ] Bonus XP for achievements
- [ ] Anti-spam protection (max XP per hour)

### Level Progression

- [ ] Level calculation: `level = floor(sqrt(total_xp / 100))`
- [ ] 100 levels maximum
- [ ] XP requirements increase exponentially
- [ ] Level progress displayed as percentage
- [ ] Next level XP requirement shown

### Level-Up Notifications

- [ ] Level-up message sent to user
- [ ] Embed with new level, total XP, next requirement
- [ ] Congratulatory message with level milestone rewards
- [ ] Notification can be toggled on/off per user
- [ ] Broadcast to guild channel (optional, configurable)

### Cross-Bot XP Tracking

- [ ] XP stored in shared database (User table)
- [ ] All bots query same XP value
- [ ] Updates are atomic (prevent race conditions)
- [ ] XP displayed consistently across all bots
- [ ] `/stats` command shows total XP and breakdown by bot

### Level Display Commands

- [ ] `/level` - Show own level and XP
- [ ] `/level @user` - Show another user's level
- [ ] `/rank` - Show rank in server
- [ ] Embed displays: level, XP, progress bar, rank

---

## Technical Notes

### XP Calculation Formula

```python
def calculate_level(total_xp: int) -> int:
    """Calculate level from total XP"""
    return int((total_xp / 100) ** 0.5)

def xp_for_level(level: int) -> int:
    """Calculate total XP needed for level"""
    return level ** 2 * 100

def xp_to_next_level(total_xp: int) -> int:
    """Calculate XP needed for next level"""
    current_level = calculate_level(total_xp)
    next_level_xp = xp_for_level(current_level + 1)
    return next_level_xp - total_xp
```

**Example Progression:**

- Level 1: 0 XP
- Level 2: 100 XP
- Level 3: 400 XP (300 more)
- Level 5: 1,000 XP
- Level 10: 4,000 XP
- Level 50: 100,000 XP
- Level 100: 400,000 XP

### XP Award Pattern

```python
# gamification/xp_system.py
async def award_xp(user_id: int, amount: int, reason: str) -> dict:
    """Award XP to user and check for level up"""
    async with get_session() as session:
        user = await session.get(User, user_id)

        old_level = calculate_level(user.total_xp)
        user.total_xp += amount
        new_level = calculate_level(user.total_xp)

        await session.commit()

        return {
            "old_xp": user.total_xp - amount,
            "new_xp": user.total_xp,
            "old_level": old_level,
            "new_level": new_level,
            "leveled_up": new_level > old_level
        }

# Usage in command
@bot.event
async def on_command_completion(ctx):
    result = await award_xp(
        user_id=ctx.author.id,
        amount=5,
        reason="command_execution"
    )

    if result["leveled_up"]:
        await ctx.send(
            embed=create_level_up_embed(
                user=ctx.author,
                new_level=result["new_level"]
            )
        )
```

### Anti-Spam Protection

```python
# Limit: 100 XP per hour per user
XP_HOURLY_LIMIT = 100
xp_tracking = defaultdict(lambda: {"xp": 0, "reset_time": time.time()})

async def award_xp_with_limit(user_id: int, amount: int):
    now = time.time()
    user_data = xp_tracking[user_id]

    # Reset if hour has passed
    if now - user_data["reset_time"] >= 3600:
        user_data["xp"] = 0
        user_data["reset_time"] = now

    # Check limit
    if user_data["xp"] + amount > XP_HOURLY_LIMIT:
        # Award partial XP to cap at limit
        amount = max(0, XP_HOURLY_LIMIT - user_data["xp"])

    if amount > 0:
        user_data["xp"] += amount
        await award_xp(user_id, amount, "command")
```

### Database Updates

```sql
-- User table already has total_xp and level columns
-- Add index for leaderboard queries
CREATE INDEX idx_users_total_xp ON users(total_xp DESC);
```

---

## UI/UX Design

### Level Display Embed

```
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘           LEVEL 15 HUNTER            â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘                                      â•‘
â•‘  Total XP: 22,500                    â•‘
â•‘  Next Level: 23,600 (1,100 more)     â•‘
â•‘                                      â•‘
â•‘  Progress: â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘ 83%            â•‘
â•‘                                      â•‘
â•‘  Server Rank: #5 / 127               â•‘
â•‘  Global Rank: #234 / 1,439           â•‘
â•‘                                      â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
```

### Level-Up Notification

```
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘       ğŸ‰ CONGRATULATIONS! ğŸ‰         â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘                                      â•‘
â•‘  You reached LEVEL 15!               â•‘
â•‘                                      â•‘
â•‘  Rewards:                            â•‘
â•‘  â€¢ +1 Free Command Cooldown Bypass   â•‘
â•‘  â€¢ Access to Level 15+ Commands      â•‘
â•‘  â€¢ Special "Hunter" Role Color       â•‘
â•‘                                      â•‘
â•‘  Next Level: 1,100 XP away           â•‘
â•‘                                      â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
```

---

## Dependencies

- Story 1.1: Shared Utilities Enhancement (database layer)
- SQLAlchemy models for User table
- Shared embed utilities

---

## Testing Requirements

- [ ] Unit tests for XP calculation formulas
- [ ] Unit tests for level-up detection
- [ ] Integration tests for XP awarding
- [ ] Test anti-spam protection
- [ ] Test cross-bot XP consistency
- [ ] Load testing for concurrent XP updates

---

## Rollout Plan

1. **Phase 1:** Implement XP system without UI
2. **Phase 2:** Add `/level` and `/rank` commands
3. **Phase 3:** Enable level-up notifications
4. **Phase 4:** Integrate with all existing bots
5. **Phase 5:** Add achievement bonuses

---

## Success Metrics

- 80%+ of active users gain XP weekly
- Level-up rate averages 1 level per 2 weeks for active users
- No XP duplication or loss (data integrity 100%)
- Commands respond in < 200ms
- Anti-spam prevents > 95% of abuse attempts

---

## Future Enhancements

- Level roles (auto-assign roles at certain levels)
- XP multipliers for premium users
- Double XP events
- XP transfer between servers
- Level prestige system (reset to 1 with prestige badge)

---

## Related Stories

- Story 2.2: Achievement System
- Story 2.3: Leaderboards
- Story 3.2: Premium Feature Gating

---

**Created:** 2025-12-21  
**Estimated Completion:** 3 weeks
