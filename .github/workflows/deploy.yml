name: Deploy to DigitalOcean VPS

on:
  push:
    branches:
      - main
  workflow_dispatch: # Allows manual triggering

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683  # v4

      - name: Deploy to VPS
        uses: appleboy/ssh-action@d134a26a1f62a1eb6f470f543cb0a988f888573d  # v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT || 22 }}
          script: |
            set -e
            # Log stored on VPS only at /var/log/discord-bots/ - never in repo
            DEPLOY_LOG="/var/log/discord-bots/deploy.log"
            mkdir -p "$(dirname "$DEPLOY_LOG")"
            log() { echo "[$(date -u '+%Y-%m-%d %H:%M:%S UTC')] $*" | tee -a "$DEPLOY_LOG"; }
            trap 'log "FAILED: Deploy exited with code $?"' ERR
            log "===== Deploy started ====="

            cd /root/discord-bots
            log "Step: backup ecosystem.config.js (untracked, keep VPS copy)"
            [ -f ecosystem.config.js ] && cp ecosystem.config.js /tmp/ecosystem.config.js.bak || true
            log "Step: git fetch/reset"
            git fetch origin main
            git reset --hard origin/main
            # Do NOT run git clean -fd: it would wipe .env, exercism workspace, todoist data
            COMMIT=$(git rev-parse --short HEAD)
            log "At commit: $COMMIT"
            if [ -f /tmp/ecosystem.config.js.bak ]; then
              mv /tmp/ecosystem.config.js.bak ecosystem.config.js
              log "Restored ecosystem.config.js (VPS config preserved)"
            elif [ ! -f ecosystem.config.js ]; then
              cp ecosystem.config.example.js ecosystem.config.js
              log "Created ecosystem.config.js from example (first deploy)"
            fi

            log "Step: npm install"
            # Update dependencies for each bot
            # hangman-bot removed - archived on 2026-01-23
            # spelling-bee-bot removed - no longer needed
            # subscription-bot not deployed remotely (local only)
            for bot in coding-practice-bot command-control-bot grammar-bot "todoist bot" reddit-filter-bot youtube-monitor-bot; do
              if [ -d "$bot" ] && [ -f "$bot/package.json" ]; then
                echo "Updating dependencies for $bot..."
                cd "$bot"
                npm install --production || {
                  log "FAILED: npm install failed for $bot"
                  exit 1
                }
                cd /root/discord-bots
              fi
            done

            log "Step: clear Python cache"
            find /root/discord-bots -type d -name "__pycache__" -exec rm -rf {} + 2>/dev/null || true
            find /root/discord-bots -name "*.pyc" -delete 2>/dev/null || true

            log "Step: pm2 restart"
            pm2 delete all 2>/dev/null || true
            pm2 start ecosystem.config.js || {
              log "FAILED: pm2 start failed"
              exit 1
            }
            pm2 save

            log "SUCCESS: Deploy completed for $COMMIT"
            pm2 list
